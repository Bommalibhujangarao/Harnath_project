<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KIRAN AGENCIES</title>
<link rel="icon" type="image/png" href="Logo-1.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--p:#3498db;--pd:#2c80b4;--bg:#fcc838;--w:#fff;--r:12px;--s:0 6px 18px rgba(0,0,0,.1)}
*{box-sizing:border-box;font-family:Segoe UI,Arial,sans-serif}
body{margin:0;background:var(--bg);overflow:hidden}
.app{display:flex;min-height:100vh;gap:5px;padding:12px}
.panel{background:var(--w);border-radius:var(--r);box-shadow:var(--s)}
.left-panel{width:25%;padding:8px}
.right-panel{width:75%;padding:12px;height:calc(100vh - 24px);overflow:auto}
h2{text-align:center;margin:6px 0;font-size:18px}
label{font:600 13px/1 Segoe UI;color:#444}
input,select{width:100%;padding:4px;border:1px solid #ccc;border-radius:8px;text-align:center;font-size:14px}
input[readonly]{background:#f5f6f7;font-weight:600}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:6px}
.field{display:flex;flex-direction:column}
.button{width:100%;height:40px;margin:12px auto 0;background:linear-gradient(135deg,var(--p),var(--pd));color:#fff;border:0;border-radius:15px;font-size:15px;font-weight:600;cursor:pointer}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:4px;text-align:center}
th{background:#0c0f45;color:#fff;position:sticky;top:0}
@media(max-width:900px){.app{flex-direction:column}.left-panel,.right-panel{width:100%}}

#loaderOverlay,#msgOverlay{
position:fixed;inset:0;display:none;align-items:center;justify-content:center;
background:rgba(0,0,0,.45);z-index:3000}
#msgOverlay{z-index:4000}

.loader{position:relative;width:180px;height:180px;display:flex;align-items:center;justify-content:center}
.loader img{width:120px;background:#fff;padding:10px;border-radius:50%;z-index:2}
.spinner-ring{
position:absolute;inset:0;border:10px solid rgba(255,255,255,.35);
border-top-color:var(--p);border-radius:50%;animation:spin 1s linear infinite}

.msgBox{
width:320px;background:#fff;border-radius:14px;padding:20px;text-align:center;
box-shadow:0 10px 30px rgba(0,0,0,.25);animation:scaleIn .2s ease}
.msgLogo{width:70px;margin-bottom:10px}
#msgText{font-size:14px;font-weight:600;color:#333;margin:10px 0 18px}
.msgBox button{
padding:8px 26px;border:0;border-radius:20px;
background:#0c0f45;color:#fff;font-weight:600;cursor:pointer}

@keyframes spin{to{transform:rotate(360deg)}}
@keyframes scaleIn{from{transform:scale(.85);opacity:0}to{transform:scale(1);opacity:1}}
</style>

</head>
<body>

<!-- Loader -->
<!-- Loader -->
<div id="loaderOverlay">
<div class="loader">
<div class="spinner-ring"></div>
<img src="Logo-1.png" alt="Loading">
</div>
</div>


<div class="app">

<!-- LEFT -->
<div class="panel left-panel">
<img src="https://i.ibb.co/BVXTy7sj/Kiran-Logo.png" style="width:90px;display:block;margin:auto">
<h2>VALUE ADDED SERVICES</h2>

<div class="grid">
<div class="field"><label>Workshop</label><select id="Loc"></select></div>
<div class="field"><label>Registration</label><input id="Regn" oninput="this.value=this.value.toUpperCase().slice(0,10)" autocomplete="off"></div>
</div>

<div class="grid">
<div class="field"><label>RO Number</label><input id="JcNo" oninput="this.value=this.value.replace(/\D/g,'').slice(0,4)"></div>
<div class="field"><label>Invoice No</label><input id="Inv" oninput="this.value=this.value.replace(/\D/g,'').slice(0,4)"></div>
</div>

<div class="grid">
<div class="field"><label>Advisor</label><select id="Adv"></select></div>
<div class="field"><label>Model</label><select id="Mod"></select></div>
</div>

<div class="grid">
<div class="field"><label>Package</label><select id="Pck"></select></div>
<div class="field"><label>Status</label>
<select id="Status">
<option>Work In Progress</option>
<option>Delivered Vehicle</option>
</select>
</div>
</div>

<div class="grid">
<div class="field"><label>Price</label><input id="CP" readonly></div>
<div class="field"><label>Discount</label><input id="DP"></div>
</div>

<div class="grid">
<div class="field"><label>Payable</label><input id="MP" readonly></div>
<div class="field"><label>Paid</label><input id="paid"></div>
</div>

<div class="grid">
<div class="field"><label>Delivered Date</label><input id="Del" type="date"></div>
<div class="field"><label>Category</label><input id="Cat" readonly></div>
</div>

<button class="button" id="saveBtn">Add Data</button>

<div style="text-align:right;font-size:12px;margin-top:8px">
Designed By : <b>B Bhujanga Rao</b>
</div>
</div>

<!-- RIGHT -->
<div class="panel right-panel">
<h2>VALUE ADDED TREATMENTS UPDATED</h2>
<table id="dataTable">
<thead>
<tr>
<th>Date</th><th>Registration</th><th>RO</th><th>Invoice</th>
<th>Workshop</th><th>Advisor</th><th>Model</th>
<th>Package</th><th>Price</th><th>Discount</th>
<th>Paid</th><th>Payable</th><th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<!-- MESSAGE BOX -->
<div id="msgOverlay">
<div class="msgBox">
<img src="https://i.ibb.co/BVXTy7sj/Kiran-Logo.png" class="msgLogo">
<div id="msgText"></div>
<button onclick="msgOverlay.style.display='none'">OK</button>
</div>
</div>
<script>
const API_URL="https://script.google.com/macros/s/AKfycbwGafddL5XT-u4m_nrbkQV_X2aTp7Rg3TAoy_0Q9PbuWJhTd78H7JzAfLDesjxxZBg1Uw/exec";
const $=id=>document.getElementById(id);

/* ===== ELEMENTS ===== */
const Loc=$("Loc"), Adv=$("Adv"), Mod=$("Mod"), Pck=$("Pck");
const Status=$("Status"), Del=$("Del");
const CP=$("CP"), DP=$("DP"), paid=$("paid"), MP=$("MP");
const Regn=$("Regn"), JcNo=$("JcNo"), Inv=$("Inv"), Cat=$("Cat");
const saveBtn=$("saveBtn");
const loaderOverlay=$("loaderOverlay");
const msgOverlay=$("msgOverlay");
const msgText=$("msgText");

/* ===== HELPERS ===== */
const show=()=>loaderOverlay.style.display="flex";
const hide=()=>loaderOverlay.style.display="none";
const showMsg=m=>{msgText.innerHTML=m;msgOverlay.style.display="flex"};
const norm=v=>(v??"").toString().trim().toLowerCase();

/* ===== DATA ===== */
let vasInfo=[], savedData=[], editIndex=null;

/* ===== VALIDATION STATE ===== */
let lastValidDiscount=0,lastValidPaid=0,lastValidStatus=Status.value,lastValidDate="";
let discountErrorShown=false, paidErrorShown=false;

/* ===== DATE RESTRICT ===== */
const today=new Date(); today.setHours(0,0,0,0);
Del.min=today.toISOString().split("T")[0];

/* ===== EVENTS ===== */
["DP","paid"].forEach(id=>$(id).addEventListener("input",calcPayable));
Status.addEventListener("change",validateStatus);
Del.addEventListener("change",validateDate);
saveBtn.addEventListener("click",saveData);

/* ================= LOAD ================= */
async function loadData(){
show();
const r=await fetch(API_URL+"?action=getData");
const j=await r.json();
vasInfo=j.VasInfo||[];
savedData=j.Data||[];
populateWorkshop();
renderTable();
hide();
}

/* ================= DROPDOWNS ================= */
function populateWorkshop(){
Loc.innerHTML='<option value="">Select Workshop</option>';
[...new Set(vasInfo.map(v=>v.Locations))]
.forEach(w=>Loc.add(new Option(w,w)));
}

Loc.onchange=()=>{
Adv.innerHTML=Mod.innerHTML=Pck.innerHTML='<option value="">Select</option>';
clearAmounts();
const rows=vasInfo.filter(v=>norm(v.Locations)===norm(Loc.value));
[...new Set(rows.map(v=>v.Advisor))].forEach(v=>Adv.add(new Option(v,v)));
[...new Set(rows.map(v=>v.Model))].forEach(v=>Mod.add(new Option(v,v)));
};

Adv.onchange = Mod.onchange = ()=>{
Pck.innerHTML='<option value="">Select Package</option>';
clearAmounts();
vasInfo
.filter(v=>norm(v.Locations)===norm(Loc.value) &&
 norm(v.Advisor)===norm(Adv.value) &&
 norm(v.Model)===norm(Mod.value))
.map(v=>v.Treatment)
.filter((v,i,a)=>a.indexOf(v)===i)
.forEach(v=>Pck.add(new Option(v,v)));
};

Pck.onchange=()=>{
clearAmounts();
const r=vasInfo.find(v=>
norm(v.Locations)===norm(Loc.value) &&
norm(v.Advisor)===norm(Adv.value) &&
norm(v.Model)===norm(Mod.value) &&
norm(v.Treatment)===norm(Pck.value)
);
if(r){
CP.value=r.Price||r.CP||0;
DP.value=r.Discount||r.DP||0;
Cat.value=r.Cat||"";
calcPayable();
}
};
function clearAmounts(force=false){
CP.value = "";
DP.value = "";
paid.value = "";
MP.value = "";
Cat.value = "";

// ðŸ”¥ reset calculation memory
if(force){
lastValidDiscount = 0;
lastValidPaid = 0;
discountErrorShown = false;
paidErrorShown = false;
}
}


/* ================= VALIDATIONS ================= */
function validateDate(){
if(!Del.value) return;
const d=new Date(Del.value); d.setHours(0,0,0,0);
if(d<today){
showMsg("Delivered Date cannot be earlier than <b>Today</b>");
Del.value=lastValidDate;
return;
}
lastValidDate=Del.value;
validateStatus();
}

function validateStatus(){
const payable=+MP.value||0;
if(Status.value==="Delivered Vehicle"){
if(payable!==0){
showMsg("Payable must be <b>ZERO</b> before delivery");
Status.value=lastValidStatus;
return;
}
if(!Del.value){
showMsg("Please select <b>Delivered Date</b>");
Status.value=lastValidStatus;
return;
}
}
lastValidStatus=Status.value;
}

/* ================= PAYABLE ================= */
function calcPayable(){
const price=+CP.value||0;
let discount=+DP.value||0;
let paidAmt=+paid.value||0;

if(discount>price*0.2){
if(!discountErrorShown){
showMsg("Discount cannot exceed <b>20%</b> of price");
	document.getElementById('DP').innerHTML=0;
discountErrorShown=true;
}
DP.value=lastValidDiscount;
discount=lastValidDiscount;
}else{
lastValidDiscount=discount;
discountErrorShown=false;
}

let payable=Math.max(price-discount,0);

if(paidAmt>payable){
if(!paidErrorShown){
showMsg("Paid amount cannot exceed payable");
paidErrorShown=true;
}
paid.value=lastValidPaid;
paidAmt=lastValidPaid;
}else{
lastValidPaid=paidAmt;
paidErrorShown=false;
}

MP.value=Math.max(payable-paidAmt,0);
validateStatus();
}
/* ================= TABLE ================= */
function renderTable(){
const tb=document.querySelector("#dataTable tbody");
tb.innerHTML="";
savedData.forEach((r,i)=>{
tb.innerHTML+=`
<tr>
<td>${r.Date_Time?new Date(r.Date_Time).toLocaleString():""}</td>
<td>${r.Registration||""}</td>
<td>${r.JCno||""}</td>
<td>${r.Invoice||""}</td>
<td>${r.Location||""}</td>
<td>${r.Advisor||""}</td>
<td>${r.Model||""}</td>
<td>${r.Treatment||""}</td>
<td>${r.CP||""}</td>
<td>${r.DP||""}</td>
<td>${r.MP||""}</td>
<td>${r.INC||""}</td>
<td><button onclick="editRow(${i})">Edit</button></td>
	 </tr>`;
});
}
/* ================= EDIT ================= */
function resetCalcState(){
lastValidDiscount=0;
lastValidPaid=0;
discountErrorShown=false;
paidErrorShown=false;
}

window.editRow=i=>{
const r=savedData[i];
editIndex=i;
saveBtn.innerText="Update Data";

resetCalcState();

Regn.value=r.Registration||"";
JcNo.value=r.JCno||"";
Inv.value=r.Invoice||"";

Loc.value=r.Location||""; Loc.onchange();
Adv.value=r.Advisor||"";
Mod.value=r.Model||""; Adv.onchange();
Pck.value=r.Treatment||""; Pck.onchange();

CP.value=r.CP||0;
DP.value=r.DP||0;

MP.value=r.Paid||0;
paid.value=r.MP||0;
lastValidDiscount=+DP.value||0;
lastValidPaid=+paid.value||0;

Status.value=r.Status||"Work In Progress";
Del.value=r.DeliveredDate||"";

calcPayable();

[Loc,Adv,Mod,Pck,CP,Regn].forEach(e=>e.disabled=true);
};

/* ================= SAVE ================= */
async function saveData(){
if(!Regn.value||!JcNo.value||!Inv.value||!Loc.value||!Adv.value||!Mod.value||!Pck.value){
showMsg("Please fill all <b>mandatory fields</b>");
return;
}

show();
const p=new URLSearchParams();
p.append("action",editIndex===null?"add":"update");
p.append("rowIndex",editIndex);

["Regn","JcNo","Inv","Loc","Adv","Mod","Pck","CP","DP","paid","MP","Status","Del","Cat"]
.forEach(id=>p.append(id,$(id).value));

await fetch(API_URL+"?"+p);

editIndex=null;
saveBtn.innerText="Add Data";
document.querySelectorAll("input,select").forEach(e=>{
e.value=""; e.disabled=false;
});
clearAmounts();
await loadData();
hide();
}

window.onload=loadData;
</script>


</body>
</html>
